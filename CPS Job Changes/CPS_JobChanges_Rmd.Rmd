---
title: "Nature and Frequency of Job Changes - CPS"
author: "Axelle Clochard"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output:
  html_document:
  toc: true
toc_depth: 3
css: memostyle.css
---
  

  
``` {r WorkspaceSetup, include = FALSE} 


# ------------------------------------------------------------------------------------------------------#
# STEP 0. SET UP WORKSPACE AND PREPARE DATA FOR Analysis
# ------------------------------------------------------------------------------------------------------#
rm(list = ls())

# Set working directory 
setwd('C:/Users/axell/OneDrive/Documents/MIT/J-WEL/Job Distance')

# Load packages 
packages <- c("knitr",
              "ggplot2",
              "scales",
              "plyr",
              "dplyr",
              "tidyr",
              "gridExtra",
              "grid",
              "readxl",
              "stringr",
              "reshape2", 
              "kableExtra",
              "stargazer", 
              "Hmisc", 
              "caret", 
              "ipumsr",
              "R.utils",
              "sandwich",
              "lmtest",
              "htmltab")

lapply(packages, require, character.only = TRUE)
options(scipen = 999)
knitr::opts_chunk$set(echo = TRUE, fig.pos= "H")


# Set the latex engine path
Sys.setenv(PATH = paste(Sys.getenv("PATH"), "C:\\Users\\axell\\AppData\\Local\\MiKTeX\\2.9\\miktex\\bin\\x64", sep=.Platform$path.sep))
knitr::opts_chunk$set(fig.pos = 'H')
```


```{r include = FALSE}
# ------------------------------------------------------------------------------------------------------#
# STEP 1. IMPORT DATA
# ------------------------------------------------------------------------------------------------------#

# Read in CPS Data
ddi <- read_ipums_ddi("cps_00003.xml")
cps <- read_ipums_micro(ddi, data_file = "cps_00003.dat.gz", verbose = FALSE)

cps$CPSID <- as.character(cps$CPSID)
cps$CPSIDP <- as.character(cps$CPSIDP)

# Keep only respondants from 2011-2019 who are part of the ASEC and in the Labor force in the current year 
cps  <- subset(cps, ASECFLAG %in% c(1, 2) &  LABFORCE == 2) %>%
         subset(., YEAR %in% c(2011:2019))

# Create an ID variable to account for ASEC oversample
cps <- cps %>% mutate(ID = ifelse(CPSIDP == "0", paste0(YEAR, "ASEC", 1:n()), CPSIDP))





### Read in Occupational Information 
occ <- read.csv("OCC Codes 2011-2019.csv")
occ$OccupationDescription_LY <- occ$OccupationDescription

cps <- merge(x = cps, y = occ[c("OCC", "OccupationDescription")], by = "OCC", all.x = T) %>%
       merge(x = .,   y = occ[c("OCC", "OccupationDescription_LY")], by.x = "OCCLY", by.y = "OCC", all.x = T)

# Import the SOC/O*Net and CPS/SOC xwalks from https://www.bls.gov/emp/documentation/crosswalks.htm
xwalk = merge(x = read_excel("./nem-occcode-cps-crosswalk.xlsx", skip = 4)[c(2,4:5)],
              y = read_excel("./nem-onet-to-soc-crosswalk.xlsx", skip = 4)[c(2,4)],
              by.x = "Hybrid SOC Code", 
              by.y = "SOC Code", 
              all = T) 
names(xwalk) <- c( "HSOC_OCC", "CPS_OCC", "CPS_Title", "ONET10_SOC_OCC")


# Import the SOC/O*Net and CPS/SOC xwalks from https://www.onetcenter.org/taxonomy/2010/soc2018.html
xwalk = merge(x = xwalk,
              y = read_excel("./2010_to_2018_SOC_Crosswalk.xlsx", skip = 3)[c(1,3:4)],
              by.x = "ONET10_SOC_OCC", 
              by.y = "O*NET-SOC 2010 Code", 
              all = T) 

names(xwalk)[5:6] <- c("ONET18_SOC", "ONET18_Title")
xwalk <- distinct(xwalk, CPS_OCC, ONET18_SOC, .keep_all = T)

# Create SOC-Level flag
xwalk$SOCLvl <- ifelse(str_sub(as.character(xwalk$ONET10_SOC_OCC), -2, -1) == "00", 1, 0)
xwalk$ONET10_SOC <- substring(as.character(xwalk$ONET10_SOC_OCC), 1, 7)

xwalk_simp <- distinct(xwalk, CPS_OCC, ONET18_SOC, .keep_all = T) %>% 
              subset(., select = -c(HSOC_OCC, ONET10_SOC_OCC))




# Subset to changed jobs and merge all
cps$OCC <- as.numeric(as.character(cps$OCC))
cps$OCCLY <- as.numeric(as.character(cps$OCCLY))

cps$OCC[cps$OCC == 0] <- NA
cps$OCCLY[cps$OCCLY == 0] <- NA 

dat <- merge(x = subset(cps, select = c(YEAR, ID, ASECWT, EMPSTAT, WORKLY, OCC, OCCLY), OCC != OCCLY),
             y = xwalk_simp,
             by.x = "OCC", by.y = "CPS_OCC", 
             all.x = T) 

dat <- merge(x = dat,
             y = xwalk_simp,
             by.x = "OCCLY", by.y = "CPS_OCC", 
             suffixes = c("","_LY"),
             all.x = T)


# Adjust weights to account for multiple matches in xwalks
dat <- merge(x = dat,
             y = dat %>% group_by(YEAR, ID) %>%
                 summarise(count = n()),
             by = c("YEAR", "ID"), all = T) %>%
       mutate(., ASECWT_adj = as.numeric(as.character(ASECWT))/count)

dat <- dat[c("YEAR", "ID", "ASECWT", "ASECWT_adj", "count", "EMPSTAT", "OCC", "OCCLY", "CPS_Title", "CPS_Title_LY", "ONET18_SOC", "ONET18_SOC_LY", "ONET18_Title", "ONET18_Title_LY")]
```



```{r include = FALSE}

# ------------------------------------------------------------------------------------------------------#
# STEP 2. CALCULATE JOB CHANGE FREQUENCY: Overall and by Title
# ------------------------------------------------------------------------------------------------------#

jc <- dat %>% 
      group_by(ONET18_SOC, ONET18_SOC_LY) %>%
      mutate(count = sum(ASECWT_adj)) %>%
      subset(select = c(ONET18_SOC, ONET18_SOC_LY, ONET18_Title, ONET18_Title_LY, count)) %>%
      distinct(., ONET18_SOC, ONET18_SOC_LY, .keep_all = T)

total = sum(jc$count)
jc <- jc %>% mutate(pct_tot = (count/total)*100)

jc <- jc %>% 
      group_by(ONET18_SOC_LY) %>%
      mutate(count_socly = sum(count))

jc$pct_socly <- (jc$count/jc$count_socly)*100
```




```{r include = FALSE}

# ------------------------------------------------------------------------------------------------------#
# STEP 3. CATEGORIZE JOB CHANGE TYPES
# ------------------------------------------------------------------------------------------------------#

jc <- jc %>%
      mutate(in_grp = ifelse(substring(ONET18_SOC, 1, 2) == substring(ONET18_SOC_LY, 1, 2), 1, 0),
             in_minor_grp = ifelse(substring(ONET18_SOC, 1, 5) == substring(ONET18_SOC_LY, 1, 5), 1, 0),
             in_broad_occ = ifelse(substring(ONET18_SOC, 1, 6) == substring(ONET18_SOC_LY, 1, 6), 1, 0))

write.csv(x=jc, file="JobChanges_2011to19.csv",  row.names = FALSE)

```





